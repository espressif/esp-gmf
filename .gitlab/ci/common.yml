variables:
  IDF_TAG_FLAG: true
  IDF_EXTRA_ACTIONS_PATH: ${CI_PROJECT_DIR}/packages/esp_board_manager

.update_source: &update_source
  - source ${CI_PROJECT_DIR}/tools/ci/utils.sh
  - add_gitlab_ssh_keys
  - git submodule update --init --recursive --depth 1
  - git clone --depth 1 -b $IDF_VERSION_TAG $IDF_REPOSITORY $IDF_PATH
  - fetch_idf_branch $IDF_VERSION_TAG
  - cd $BASE_FRAMEWORK_PATH
  - git log -2
  - common_before_scripts
  - setup_tools_and_idf_python_venv
  - set_env_variable
  - cd ${CI_PROJECT_DIR}

.build_template:
  stage: build
  image: ${IMAGE}
  interruptible: true
  tags:
    - multimedia_build
  before_script:
    - *update_source
  after_script:
    - find "${TEST_DIR}" -type d \( -name "managed_components" -o -name "build" \) -exec rm -rf {} +

.target_test_template:
  stage: target_test
  image: "$CI_DOCKER_REGISTRY/target-test-env-v5.4:2"
  interruptible: true
  timeout: 1 hour
  retry: 2
  cache:
    # Usually do not need submodule-cache in target_test
    - key: pip-cache
      paths:
        - .cache/pip
      policy: pull
  before_script:
    - source ${CI_PROJECT_DIR}/tools/ci/utils.sh
    - add_gitlab_ssh_keys
    - git clone --depth 1 -b $IDF_VERSION_TAG $IDF_REPOSITORY $IDF_PATH
    - check_idf_version $IDF_VERSION_TAG
    - export PYTHONPATH="$IDF_PATH/tools:$IDF_PATH/tools/ci/python_packages:$PYTHONPATH"
    - export PYTHONPATH="$CI_PROJECT_DIR/tools:$PYTHONPATH"
