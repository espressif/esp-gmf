variables:
  BASE_FRAMEWORK_PATH: "${IDF_PATH}"
  BASE_FRAMEWORK: $IDF_REPOSITORY
  IDF_TAG_FLAG: true

.build_gmf_component:
  interruptible: true
  variables:
    TARGET_DIR_TYPE: "test_apps"
    TEST_DIR: ${CI_PROJECT_DIR}/gmf_core
  parallel:
    matrix:
      - IDF_VERSION_TAG: ['v5.4.3']
        parallel: [ 1/1 ]
  extends:
    - .rules:build:protected-merge-requests-pipeline
    - .build_template
  artifacts:
    paths:
      - "**/build*/size.json"
      - "**/build*/build_log.txt"
      - "**/build*/*.bin"
      - "**/build*/*.elf"
      - "**/build*/flasher_args.json"
      - "**/build*/flash_project_args"
      - "**/build*/config/sdkconfig.json"
      - "**/build*/sdkconfig"
      - "**/build*/bootloader/*.bin"
      - "**/build*/partition_table/*.bin"
      - "**/build*/srmodels/*.bin"
      - "${TEST_DIR}/**/test_apps/*.py"
    expire_in: 4 days
  script:
    - python $CI_PROJECT_DIR/tools/ci/esp_bmgr_pre_build.py --target $IDF_TARGET --board $AUDIO_BOARD --project-path ${TEST_DIR} --target-dir-type ${TARGET_DIR_TYPE}
    - run_cmd python $CI_PROJECT_DIR/tools/ci/build_apps.py ${TEST_DIR} \
        -t $IDF_TARGET -vv \
        --target-dir-type ${TARGET_DIR_TYPE} \
        --build-dir ${IDF_VERSION_TAG}/build_@t_@w \
        --parallel-count ${parallel##*/} \
        --parallel-index ${parallel%%/*}
    - python $CI_PROJECT_DIR/tools/ci/check_test_cxx_build.py

.build_ut_gmf_packages:
  extends:
    - .build_gmf_component
  variables:
    TEST_DIR: ${CI_PROJECT_DIR}/packages

.build_ut_gmf_elements:
  extends:
    - .build_gmf_component
  variables:
    TEST_DIR: ${CI_PROJECT_DIR}/elements

build_ut_gmf_core_esp32:
  extends:
    - .build_gmf_component
  variables:
    IDF_TARGET: esp32
    AUDIO_BOARD: lyrat_mini_v1_1

.build_ut_gmf_core_esp32c3:
  extends:
    - .build_gmf_component
  variables:
    IDF_TARGET: esp32c3

build_ut_gmf_core_esp32s3:
  extends:
    - .build_gmf_component
  variables:
    IDF_TARGET: esp32s3
    AUDIO_BOARD: esp32_s3_korvo2_v3

.build_ut_gmf_core_esp32p4:
  extends:
    - .build_gmf_component
  variables:
    IDF_TARGET: esp32p4
    AUDIO_BOARD: esp32_p4_function_ev

build_ut_gmf_elements_esp32:
  extends:
    - .build_ut_gmf_elements
  variables:
    IDF_TARGET: esp32
    AUDIO_BOARD: lyrat_mini_v1_1

build_ut_gmf_elements_esp32s3:
  extends:
    - .build_ut_gmf_elements
  variables:
    IDF_TARGET: esp32s3
    AUDIO_BOARD: esp32_s3_korvo2_v3

.build_ut_gmf_elements_esp32p4:
  extends:
    - .build_ut_gmf_elements
  variables:
    IDF_TARGET: esp32p4
    AUDIO_BOARD: esp32_p4_function_ev

build_ut_gmf_packages_esp32:
  extends:
    - .build_ut_gmf_packages
  variables:
    IDF_TARGET: esp32
    AUDIO_BOARD: lyrat_mini_v1_1

build_ut_gmf_packages_esp32s3:
  extends:
    - .build_ut_gmf_packages
  variables:
    IDF_TARGET: esp32s3
    AUDIO_BOARD: esp32_s3_korvo2_v3
